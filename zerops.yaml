zerops:
  - setup: signoz
    build:
      base: ubuntu@22.04
      envVariables:
        CI: true
      prepareCommands:
        - sudo apt-get install -y build-essential
        - sudo -E zsc install nodejs@22
        - sudo -E zsc install go@1.22
      buildCommands:
        - git clone https://github.com/SigNoz/signoz
        - cd signoz/frontend && yarn install --no-immutable
        - cd signoz && make go-build-community-amd64 OS=linux
      deployFiles:
        - ./signoz/frontend/build/~
      addToRunPrepare:
        - ./signoz/target/linux-amd64/signoz-community
    run:
      base: ubuntu@22.04
      envVariables:
        SIGNOZ_SQLSTORE_PROVIDER: postgres
        SIGNOZ_SQLSTORE_POSTGRES_DSN: postgres://${metadata_user}:${metadata_password}@${metadata_hostname}:${metadata_port}/${metadata_dbName}?sslmode=disable
        SIGNOZ_TELEMETRYSTORE_PROVIDER: clickhouse
        SIGNOZ_TELEMETRYSTORE_CLICKHOUSE_DSN: tcp://${clickhouse_hostname}:${clickhouse_portNative}?username=${clickhouse_user}&password=${clickhouse_password}
        SIGNOZ_WEB_UI_PATH: /var/www
      ports:
        - port: 8080
          httpSupport: true
        - port: 4317
          protocol: tcp
      prepareCommands:
        - ls -la ./target/linux-amd64/
        - ls -la ./target/linux-amd64/signoz-community
        - sudo mv ./target/linux-amd64/signoz-community /usr/local/bin/signoz
        - sudo chmod +x /usr/local/bin/signoz
      start: signoz server

  - setup: otelcollector
    run:
      base: ubuntu@22.04
      envVariables:
        OTEL_EXPORTER_OTLP_ENDPOINT: http://signoz:4317
        OTEL_EXPORTER_OTLP_INSECURE: true
      ports:
        - port: 4317
          protocol: tcp
        - port: 4318
          httpSupport: true
        - port: 54527
          protocol: tcp
        - port: 13133
          httpSupport: true
        - port: 8888
          httpSupport: true
      prepareCommands:
        - wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.135.0/otelcol-contrib_0.135.0_linux_amd64.tar.gz
        - tar -xzf otelcol-contrib_0.135.0_linux_amd64.tar.gz
        - sudo mv otelcol-contrib /usr/local/bin/otelcol
      start: otelcol --config=otel-config.yaml
