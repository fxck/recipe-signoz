zerops:
  - setup: signoz
    run:
      base: ubuntu@22.04
      envVariables:
        SIGNOZ_SQLSTORE_PROVIDER: postgres
        SIGNOZ_SQLSTORE_POSTGRES_DSN: postgres://${metadata_user}:${metadata_password}@${metadata_hostname}:${metadata_port}/${metadata_dbName}?sslmode=disable
        SIGNOZ_TELEMETRYSTORE_PROVIDER: clickhouse
        SIGNOZ_TELEMETRYSTORE_CLICKHOUSE_DSN: tcp://${clickhouse_hostname}:${clickhouse_portNative}?username=${clickhouse_user}&password=${clickhouse_password}
        SIGNOZ_WEB_UI_PATH: /etc/signoz/web
      ports:
        - port: 8080
          httpSupport: true
        - port: 4317
          protocol: tcp
      prepareCommands:
        - wget https://github.com/SigNoz/signoz/releases/download/v0.95.1/signoz-community_linux_amd64.tar.gz
        - tar -xzf signoz-community_linux_amd64.tar.gz
        - sudo mkdir -p /etc/signoz
        - sudo cp -r signoz-community_linux_amd64/web /etc/signoz/
        - sudo cp -r signoz-community_linux_amd64/config /etc/signoz/ || true
        - sudo cp signoz-community_linux_amd64/bin/signoz /usr/local/bin/
        - sudo chmod +x /usr/local/bin/signoz
      start: signoz server

  - setup: otelcollector
    run:
      base: ubuntu@22.04
      envVariables:
        OTEL_EXPORTER_OTLP_ENDPOINT: http://signoz:4317
        OTEL_EXPORTER_OTLP_INSECURE: true
      ports:
        - port: 4317
          protocol: tcp      # OTLP gRPC
        - port: 4318
          httpSupport: true  # OTLP HTTP
        - port: 54527
          protocol: tcp      # Syslog TCP (not 514!)
        - port: 13133
          httpSupport: true  # Prometheus Remote Write
        - port: 8888
          httpSupport: true  # Prometheus metrics
      prepareCommands:
        - wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.135.0/otelcol-contrib_0.135.0_linux_amd64.tar.gz
        - tar -xzf otelcol-contrib_0.135.0_linux_amd64.tar.gz
        - sudo mv otelcol-contrib /usr/local/bin/otelcol
      start: otelcol --config=otel-config.yaml
